# LLM-KTR-Lineage 架构设计文档

## 系统概述

LLM-KTR-Lineage 是一个基于LLM的Pentaho Kettle转换文件分析工具，用于自动解析KTR文件并生成字段映射文档。

## 核心架构

### 系统组件

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   KTR文件输入    │ -> │   LLM处理器     │ -> │   文档输出       │
│  (sample目录)    │    │  (Pydantic AI)  │    │  (output目录)   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
    .ktr XML文件            字段映射分析            Markdown文档
```

### 核心类设计

#### KTRProcessor (主处理类)
- **职责**: 协调整个处理流程
- **关键属性**:
  - `agent`: Pydantic AI智能体
  - `failed_files`: 失败文件追踪
  - 配置参数(API端点、令牌、模型等)

#### 数据处理流程
1. **文件发现**: 扫描sample目录下的.ktr文件
2. **内容读取**: 读取XML格式的KTR文件内容
3. **LLM分析**: 使用智能体解析字段映射关系
4. **结果保存**: 生成Markdown格式的映射文档

### 技术栈

- **语言**: Python 3.13+
- **核心框架**: Pydantic AI
- **LLM集成**: OpenAI兼容API
- **日志**: Loguru
- **进度显示**: Tqdm
- **配置管理**: python-dotenv

## 设计原则

### 1. 单一职责原则
- `KTRProcessor` 专注于KTR文件处理
- 文件发现、处理、错误处理职责分离

### 2. 异步处理
- 使用asyncio实现异步文件处理
- 避免I/O阻塞，提高处理效率

### 3. 错误恢复
- 单文件失败不影响其他文件处理
- 详细的失败报告生成

### 4. 配置驱动
- 环境变量管理敏感信息
- 系统提示词可配置化

## 扩展性设计

### 插件化架构
- 支持不同的LLM提供商
- 可扩展的输出格式
- 自定义处理逻辑

### 监控和日志
- 结构化日志记录
- 处理进度可视化
- 详细的错误追踪