# LLM-KTR-Lineage 数据流文档

## 整体数据流

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  输入数据     │ -> │  并发任务队列  │ -> │  LLM分析     │ -> │  输出数据     │
│  (KTR文件)   │    │ (Semaphore=3) │    │  (字段映射)   │    │  (文档)       │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │                   │
       ▼                   ▼                   ▼                   ▼
   多个KTR文件        并发处理任务池       实时API调用        Markdown文档
```

## 详细数据流转

### 1. 输入数据流

#### KTR文件格式
- **格式**: XML
- **编码**: UTF-8
- **位置**: `./sample/` 目录
- **示例结构**:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<transformation>
  <info>
    <name>转换名称</name>
    <description>转换描述</description>
  </info>
  <step>
    <!-- 转换步骤定义 -->
  </step>
</transformation>
```

#### 配置数据
- **来源**: 环境变量
- **格式**: Key-Value对
- **关键配置**:
  - `API_ENDPOINTS`: LLM服务端点
  - `API_TOKEN`: 认证令牌
  - `SYSTEM_PROMPT`: 系统提示词
  - `MODEL_NAME`: 模型标识

### 2. 处理数据流

#### 文件内容读取
- **操作**: 文件I/O读取
- **编码**: UTF-8
- **内存管理**: 按需读取，避免大文件内存溢出

#### 预处理数据
- **格式**: 字符串
- **内容**: 完整的KTR XML内容
- **大小**: 原始文件大小

### 3. LLM分析数据流

#### 请求数据
```python
{
    "system_prompt": "输出字段映射文档...",
    "user_input": "KTR文件XML内容"
}
```

#### 响应数据
- **格式**: 结构化文本
- **内容**: 字段映射表
- **示例响应**:
```markdown
| 源字段 | 目标字段 | 变换路径 | 变换类型 | 变换说明 |
|--------|----------|----------|----------|----------|
| ID_BATCH | batch_id | 日志表 | 字段映射 | 批次ID |
| CHANNEL_ID | channel_id | 日志表 | 字段映射 | 通道ID |
```

#### 使用统计
- **数据**: 令牌使用量、处理时间
- **用途**: 监控和计费

### 4. 输出数据流

#### 成功输出
- **格式**: Markdown
- **位置**: `./output/` 目录
- **命名**: `{原文件名}.md`
- **内容**: 字段映射文档

#### 失败输出
- **格式**: Markdown报告
- **位置**: `fail.md`
- **内容**: 失败文件列表和统计

#### 日志数据
- **应用日志**: `app.log`
  - 处理进度
  - 成功统计
  - 一般信息
- **错误日志**: `error.log`
  - 异常信息
  - 处理失败详情

## 数据转换过程

### KTR XML → 字段映射（并发处理）

1. **任务创建**: 为所有KTR文件创建异步处理任务
2. **信号量控制**: 使用Semaphore限制并发数量为3个
3. **并发执行**: 最多3个文件同时进行LLM分析
4. **实时追踪**: 通过as_completed监听任务完成状态
5. **结果保存**: 完成的任务立即写入输出文件
6. **进度更新**: 实时更新进度条显示完成数量

### 错误数据处理

1. **异常捕获**: 处理过程中的所有异常
2. **失败记录**: 记录失败文件路径
3. **报告生成**: 汇总失败信息

## 数据存储策略

### 临时数据
- **文件内容**: 内存中临时存储
- **处理结果**: 立即写入磁盘
- **错误信息**: 内存中累积，最后写入

### 持久化数据
- **输出文档**: `./output/` 目录
- **失败报告**: `fail.md`
- **日志文件**: `app.log`, `error.log`

### 配置数据
- **存储**: 环境变量
- **加载**: 应用启动时
- **验证**: 初始化时检查完整性

## 数据安全考虑

### 敏感信息
- **API令牌**: 环境变量管理，不写入代码
- **配置信息**: 通过.env文件管理

### 数据完整性
- **文件处理**: 原子操作，避免部分写入
- **错误恢复**: 失败文件不影响成功文件
- **日志追踪**: 完整的处理历史记录